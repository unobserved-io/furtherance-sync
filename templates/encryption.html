<!--
Furtherance Sync
Copyright (C) 2024  Ricky Kresslein <rk@unobserved.io>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <https://www.gnu.org/licenses/>.
-->

<!doctype html>
<html>
    <head>
        <title>Encryption Setup - Furtherance</title>
        <style>
            /* Previous styles remain the same */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }
            .modal-content {
                position: relative;
                background-color: white;
                margin: 15% auto;
                padding: 20px;
                border-radius: 5px;
                max-width: 500px;
                width: 90%;
            }
            .confirmation-dialog {
                display: none;
                margin-top: 20px;
                padding: 15px;
                background-color: #fff3cd;
                border: 1px solid #ffeeba;
                border-radius: 3px;
            }
            .confirmation-dialog input {
                width: 100%;
                padding: 8px;
                margin: 10px 0;
                border: 1px solid #ced4da;
                border-radius: 3px;
            }
            .close {
                position: absolute;
                right: 10px;
                top: 5px;
                font-size: 24px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2>Encryption Key Setup</h2>

            {% match error_msg %} {% when Some with (error) %}
            <div class="error">{{ error }}</div>
            {% when None %} {% endmatch %} {% match success_msg %} {% when Some
            with (msg) %}
            <div class="success">{{ msg }}</div>
            {% when None %} {% endmatch %}

            <div class="warning">
                <strong>Important:</strong>
                <ul>
                    <li>Your encryption key is used to protect your data.</li>
                    <li>
                        Once generated, the key will only be shown once - you
                        must save it immediately.
                    </li>
                    <li>
                        Store it somewhere safe - if you lose it, you won't be
                        able to access your encrypted data.
                    </li>
                    <li>
                        This key is different from your password and cannot be
                        reset.
                    </li>
                </ul>
            </div>

            {% if has_key %}
            <p>An encryption key is currently set up.</p>
            {% endif %}

            <div class="button-group">
                <button
                    type="button"
                    class="generate-btn"
                    onclick="handleGenerateClick()"
                >
                    Generate {% if has_key %}New{% endif %} Key
                </button>
            </div>

            <div class="confirmation-dialog" id="confirmationDialog">
                <p>
                    <strong>Warning:</strong> Generating a new key will
                    invalidate your existing key. All clients will need to be
                    updated with the new key.
                </p>
                <p>Type "generate" below to confirm:</p>
                <input
                    type="text"
                    id="confirmationInput"
                    placeholder="Type 'generate' to confirm"
                />
                <button onclick="confirmGenerate()" class="generate-btn">
                    Confirm
                </button>
                <button onclick="cancelGenerate()" class="save-btn">
                    Cancel
                </button>
            </div>
        </div>

        <div id="keyModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h3>Your Encryption Key</h3>
                <div class="warning">
                    <strong>WARNING: Save this key now!</strong>
                    <ul>
                        <li>This is the only time you will see this key.</li>
                        <li>
                            Store it in a secure password manager or other safe
                            location.
                        </li>
                        <li>
                            Without this key, your data cannot be recovered.
                        </li>
                    </ul>
                </div>
                <div class="key-display" id="modalKeyDisplay"></div>
                <button onclick="closeModal()" class="save-btn">
                    I Have Saved My Key
                </button>
            </div>
        </div>

        <script>
            function handleGenerateClick() {
                const hasKey = {{ has_key|json }};
                if (hasKey) {
                    document.getElementById('confirmationDialog').style.display = 'block';
                } else {
                    generateKey();
                }
            }

            async function generateKey(confirmation = null) {
                try {
                    const response = await fetch('/api/encryption/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: confirmation ? JSON.stringify({ confirmation }) : null
                    });

                    const data = await response.json();

                    if (response.status === 400 && data.error === 'confirmation_required') {
                        document.getElementById('confirmationDialog').style.display = 'block';
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to generate key');
                    }

                    // Show the key in the modal
                    document.getElementById('modalKeyDisplay').textContent = data.key;
                    document.getElementById('keyModal').style.display = 'block';
                    document.getElementById('confirmationDialog').style.display = 'none';
                } catch (error) {
                    alert('Error generating key: ' + error.message);
                }
            }

            function confirmGenerate() {
                const confirmationInput = document.getElementById('confirmationInput');
                if (confirmationInput.value === 'generate') {
                    generateKey('generate');
                } else {
                    alert('Please type "generate" to confirm');
                }
            }

            function cancelGenerate() {
                document.getElementById('confirmationDialog').style.display = 'none';
                document.getElementById('confirmationInput').value = '';
            }

            function closeModal() {
                document.getElementById('keyModal').style.display = 'none';
                location.reload(); // Refresh to show updated state
            }
        </script>
    </body>
</html>
